name: zap
on: workflow_dispatch

jobs:
  zap_scan:
    runs-on: ubuntu-latest
    name: Scan the webapplication
    env:
      CYPRESS_password: ${{ secrets.CYPRESS_PASSWORD }}
    steps:
      - name: Checkout
        uses: actions/checkout@v2
        with:
          ref: dev
      - name: Subtitute Password
        working-directory: ./testing/zap
        run:
          echo Git Event Name: ${{ github.event_name }}
          echo Git Event Action: ${{ github.event.action }}
          echo Git Labels: "$LABELS"
          echo PR in Draft: ${{ github.event.pull_request.draft }}
          echo Path: $(pwd)
          LOCAL_VAR=$(echo 'cypressidir$CYPRESS_PW' | base64)
          sed -i 's/@pw@/'$LOCAL_VAR'/g' dev.context
      - name: Copy context
        run:
          echo working dir: ${{env.working-directory}}
          cd /
          echo Location: $(find -name dev.context)
      - name: ZAP Scan
        uses: zaproxy/action-full-scan@v0.3.0
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          docker_name: 'owasp/zap2docker-stable'
          target: 'https://dev-biohubbc.apps.silver.devops.gov.bc.ca/'
          cmd_options: '-a -n ./testing/zap/dev.context'
